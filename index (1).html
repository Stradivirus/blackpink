<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>글로벌 사이버보안 위협 대시보드</title>
    <!-- New font imports for a luxurious feel -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for luxurious feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1A1A2E; /* Deep Blue-Purple */
            color: #E0E0FF; /* Soft Off-White/Lavender */
        }
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
            color: #FFD700; /* Gold for headings */
        }
        .panel { /* Reusable class for the main content blocks */
            background-color: #2A2A4A; /* Slightly Lighter Blue-Purple */
            padding: 2.5rem; /* Increased padding */
            border-radius: 1rem; /* More rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4); /* Deeper shadow */
            border: 1px solid rgba(138, 43, 226, 0.3); /* Subtle violet border */
        }
        .btn-primary { /* For upload/download buttons */
            background: linear-gradient(to right, #8A2BE2, #9932CC); /* Violet gradient */
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(138, 43, 226, 0.3);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(to right, #9932CC, #8A2BE2);
            box-shadow: 0 6px 15px rgba(138, 43, 226, 0.5);
            transform: translateY(-2px);
        }
        .btn-delete { /* For delete button */
            background-color: #dc2626; /* Red-600 */
            color: white;
            font-weight: 600;
            padding: 0.5rem 1rem; /* Smaller padding for delete */
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(220, 38, 38, 0.3);
            border: none;
        }
        .btn-delete:hover {
            background-color: #b91c1c; /* Red-700 */
            box-shadow: 0 3px 8px rgba(220, 38, 38, 0.5);
            transform: translateY(-1px);
        }

        /* GCI Header Centering */
        .gci-header-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center horizontally */
            text-align: center; /* Fallback for text */
        }
        .gci-header-container h2 {
            margin-bottom: 0.5rem; /* Adjust spacing below title */
        }
        .gci-year {
            font-size: 2.5rem; /* Larger font for year */
            font-weight: 700;
            color: #FFD700; /* Gold color */
            line-height: 1; /* Tighten line height */
        }


        #map {
            height: 650px; /* Even taller map */
            width: 100%;
            border-radius: 0.75rem; /* More rounded corners for map */
            border: 2px solid #8A2BE2; /* More prominent border matching accent */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* Soft shadow for map */
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background: #2A2A4A !important; /* Popup background matches panel */
            color: #E0E0FF !important; /* Popup text color */
            box-shadow: 0 3px 10px rgba(0,0,0,0.3) !important;
            border-radius: 0.5rem !important;
        }
        .leaflet-control-attribution {
            color: #E0E0FF !important; /* Attribution text color */
        }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: #3F3F6B !important; /* Zoom control background */
            color: #E0E0FF !important;
            border-radius: 0.25rem !important;
            border: none !important;
        }
        .leaflet-control-container .leaflet-control {
            margin: 0.75rem !important; /* Slightly increased margin for controls */
        }
        
        /* Legend Styles */
        .info.legend {
            background: rgba(42, 42, 74, 0.9); /* Legend background matches panel with transparency */
            padding: 12px; /* Increased padding */
            border-radius: 10px; /* More rounded */
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            color: #E0E0FF;
            font-size: 13px; /* Slightly smaller font for legend */
        }
        .info.legend i {
            width: 16px; /* Smaller swatch size */
            height: 16px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border-radius: 50%; /* Make the color swatches circular */
            border: 1px solid #E0E0FF; /* Border around color swatches */
        }
        .info.legend span {
            line-height: 16px; /* Align text with swatches */
            color: #E0E0FF;
        }

        /* Blinking animation for High risk */
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.3; } /* Less opaque at peak of blink */
            100% { opacity: 1; }
        }
        .leaflet-high-risk-marker-blink {
            animation: blink 1s infinite alternate; /* Blink animation */
        }

        /* Table specific styles for luxury */
        table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 0.75rem; /* Rounded table */
            overflow: hidden; /* For border-radius to work on children */
        }
        thead {
            background-color: #3F3F6B; /* Darker blue-purple header */
        }
        tbody tr {
            background-color: #2A2A4A; /* Same as panel background */
        }
        tbody tr:nth-child(odd) {
            background-color: #35355D; /* Slightly different shade for zebra striping */
        }
        tbody td {
            border-bottom: 1px solid rgba(138, 43, 226, 0.1); /* Subtle row divider */
        }
        tbody tr:last-child td {
            border-bottom: none; /* No border on last row */
        }
        
        /* Input field specific styles */
        input[type="text"], input[type="file"] {
            background-color: #3F3F6B; /* Darker input fields */
            border-color: #555588; /* Border color for inputs */
            color: #E0E0FF;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2); /* Inner shadow for depth */
        }
        input[type="text"]:focus, input[type="file"]:focus {
            border-color: #8A2BE2; /* Accent color on focus */
            outline: none;
            box-shadow: 0 0 0 2px rgba(138, 43, 226, 0.5); /* Ring effect on focus */
        }
        input[type="file"]::file-selector-button {
            background-color: #8A2BE2; /* File input button color */
            color: white;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #9932CC;
        }
    </style>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          crossorigin=""/>
</head>
<body class="p-8 min-h-screen">
    <h1 class="text-5xl font-bold text-center mb-10 text-gold-300">글로벌 사이버보안 위협 대시보드</h1>
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-10"> <!-- Increased gap -->
        <!-- GCI 사이버보안 순위 섹션 -->
        <div class="panel col-span-1">
            <div class="gci-header-container">
                <h2 class="text-3xl font-semibold text-gold-300">GCI 사이버보안 순위</h2>
                <span id="current-gci-year" class="gci-year">(2025년)</span>
            </div>
            <div class="rounded-xl border border-gray-700"> <!-- Removed overflow-x-auto -->
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-gray-300 uppercase tracking-wider rounded-tl-lg">순위</th> <!-- Text size increased to xl -->
                            <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-gray-300 uppercase tracking-wider">국가</th> <!-- Text size increased to xl -->
                            <th scope="col" class="px-6 py-3 text-left text-xl font-medium text-gray-300 uppercase tracking-wider rounded-tr-lg">점수</th> <!-- Text size increased to xl -->
                        </tr>
                    </thead>
                    <tbody id="gci-rankings-body" class="divide-y divide-gray-700 text-lg"> <!-- Changed from text-sm to text-lg for bigger font -->
                        <!-- GCI 랭킹 데이터가 여기에 로드됩니다 -->
                    </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-300 mt-5">※ 데이터는 매일 자정(한국시간)에 업데이트됩니다.<br>
            <span class="text-purple-300 font-semibold">※ 순위가 낮을수록(1위에 가까울수록) 사이버보안 수준이 높음을 의미합니다.</span></p>
        </div>

        <!-- 위험 국가 매핑 섹션 -->
        <div class="panel col-span-1 lg:col-span-2">
            <h2 class="text-3xl font-semibold mb-6 text-gold-300">위험 국가 매핑</h2>
            <div id="map" class="rounded-lg"></div>
            <div id="alert-message" class="hidden mt-4 p-3 bg-red-600 rounded-lg text-white font-medium flex items-center justify-between">
                네트워크 오류 또는 서버 연결 문제.
                <button onclick="document.getElementById('alert-message').classList.add('hidden')" class="ml-4 px-3 py-1 rounded-md bg-red-700 hover:bg-red-800 transition-colors">확인</button>
            </div>
        </div>

        <!-- 위협 리포트 섹션 -->
        <div class="panel col-span-1 lg:col-span-3 mt-10"> <!-- Increased top margin -->
            <h2 class="text-3xl font-semibold mb-6 text-gold-300">위협 리포트</h2>
            
            <!-- 업로드된 리포트 목록 -->
            <h3 class="text-2xl font-medium mb-4 text-gold-300">리포트 목록</h3> <!-- Changed title to "리포트 목록" -->
            <div id="threat-reports-list" class="space-y-4 mb-8 text-base"> <!-- Larger spacing and base font -->
                <!-- 위협 리포트 목록이 여기에 로드됩니다 -->
            </div>
            <div id="reports-loading" class="text-center text-gray-300 text-base mt-6">리포트 로딩 중...</div>
            <div id="reports-error" class="hidden text-red-400 text-center text-base mt-6">리포트를 불러오는 데 실패했습니다.</div>

            <!-- 리포트 업로드 폼 -->
            <form id="upload-form" class="mt-8 p-6 bg-gray-800 rounded-xl shadow-md"> <!-- Darker background for form, more shadow -->
                <h3 class="text-2xl font-medium mb-4 text-gold-300">리포트 업로드</h3>
                <div class="mb-4">
                    <label for="report-title" class="block text-sm font-medium text-gray-300 mb-2">리포트 제목</label>
                    <input type="text" id="report-title" name="title"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 text-base"
                           placeholder="리포트 제목 입력" required>
                </div>
                <div class="mb-6">
                    <label for="report-file" class="block text-sm font-medium text-gray-300 mb-2">파일 선택 (PDF)</label>
                    <input type="file" id="report-file" name="file" accept=".pdf"
                           class="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-base file:font-semibold file:bg-purple-700 file:text-white hover:file:bg-purple-800 cursor-pointer" required>
                </div>
                <button type="submit"
                        class="w-full btn-primary">
                    리포트 업로드
                </button>
                <div id="upload-status" class="mt-4 text-center text-sm font-medium hidden"></div>
            </form>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            crossorigin=""></script>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000/api'; // FastAPI 백엔드 URL

        // 메시지 박스 표시 함수 (alert 대신 사용)
        function showMessageBox(message, type = 'info') {
            const alertDiv = document.getElementById('alert-message');
            alertDiv.textContent = message;
            // Ensure the close button is recreated or its click handler is reset
            let closeButton = alertDiv.querySelector('button');
            if (!closeButton) {
                closeButton = document.createElement('button');
                closeButton.textContent = '확인';
                alertDiv.appendChild(closeButton);
            }
            closeButton.onclick = () => alertDiv.classList.add('hidden');

            alertDiv.className = `mt-4 p-3 rounded-lg text-white font-medium flex items-center justify-between transition-opacity duration-300`;
            if (type === 'error') {
                alertDiv.classList.add('bg-red-600');
                closeButton.classList.add('bg-red-700');
            } else if (type === 'success') {
                alertDiv.classList.add('bg-green-600');
                closeButton.classList.add('bg-green-700');
            } else {
                alertDiv.classList.add('bg-blue-600');
                closeButton.classList.add('bg-blue-700');
            }
            closeButton.className = 'ml-4 px-3 py-1 rounded-md bg-opacity-50 hover:bg-opacity-75 transition-colors';
            alertDiv.classList.remove('hidden');
        }

        // GCI 랭킹 데이터 가져오기 및 표시
        async function fetchGCIRankings() {
            try {
                const response = await fetch(`${API_BASE_URL}/gci_rankings`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const rankings = await response.json();
                const tbody = document.getElementById('gci-rankings-body');
                tbody.innerHTML = ''; // 기존 내용 지우기
                rankings.forEach(ranking => {
                    const row = tbody.insertRow();
                    row.className = 'hover:bg-gray-700 transition-colors';
                    // Apply text-xl here for larger text in table cells
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-xl font-medium text-gray-200">${ranking.rank}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xl text-gray-300">${ranking.country}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-xl text-gray-300">${ranking.score.toFixed(3)}</td>
                    `;
                });
            }
            catch (error) {
                console.error("GCI 랭킹을 불러오는 데 실패했습니다:", error);
                showMessageBox('GCI 랭킹을 불러오는 데 실패했습니다.', 'error');
            }
        }

        // 지도 초기화 및 위험 국가 데이터 표시
        let map;
        function initializeMap() {
            if (map) { // 지도가 이미 초기화된 경우 기존 지도 파괴
                map.remove();
            }
            map = L.map('map').setView([30, 0], 2); // 초기 지도 중심과 줌 레벨

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors',
                noWrap: true // 지도 반복 방지
            }).addTo(map);

            // Add legend to the map
            addMapLegend(map);
        }

        // Function to add legend to the map
        function addMapLegend(mapInstance) {
            const legend = L.control({position: 'bottomright'});

            legend.onAdd = function (mapInstance) {
                const div = L.DomUtil.create('div', 'info legend');
                const levels = ['High', 'Medium', 'Low'];
                const colors = {
                    'High': 'red',
                    'Medium': 'orange',
                    'Low': 'green'
                };

                div.innerHTML += '<strong class="text-gray-100 text-base mb-2 block">위험 수준</strong>';

                for (let i = 0; i < levels.length; i++) {
                    const level = levels[i];
                    const color = colors[level];
                    // Apply blinking class only for 'High' risk
                    const className = `risk-color-${level.toLowerCase()}${level === 'High' ? ' leaflet-high-risk-marker-blink' : ''}`;
                    div.innerHTML +=
                        '<i class="' + className + '" style="background:' + color + '"></i> ' +
                        '<span>' + level + '</span><br>';
                }
                return div;
            };

            legend.addTo(mapInstance);
        }

        async function fetchRiskyCountriesMapData() {
            try {
                const response = await fetch(`${API_BASE_URL}/risky_countries/map_data`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const geojsonData = await response.json();

                // 기존 마커 제거 (필요하다면)
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
                        map.removeLayer(layer);
                    }
                });

                geojsonData.features.forEach(feature => {
                    const coords = feature.geometry.coordinates; // [longitude, latitude]
                    const props = feature.properties;

                    let color;
                    let markerClassName = ''; // Class for blinking animation
                    switch(props.risk_level) {
                        case 'High': 
                            color = 'red'; 
                            markerClassName = 'leaflet-high-risk-marker-blink'; // Add blinking class
                            break;
                        case 'Medium': color = 'orange'; break;
                        case 'Low': color = 'green'; break;
                        default: color = 'blue';
                    }

                    // 원형 마커 사용
                    const marker = L.circleMarker([coords[1], coords[0]], {
                        radius: 8,
                        fillColor: color,
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    // Apply the blinking class to the SVG element representing the marker
                    // Leaflet's circleMarker uses an SVG <path> element.
                    // The ._path property holds a reference to this SVGPathElement.
                    if (markerClassName && marker._path) {
                        marker._path.classList.add(markerClassName);
                    }


                    marker.bindPopup(`
                        <strong class="text-lg">${props.country}</strong><br>
                        위험 수준: <span style="color: ${color}; font-weight: bold;">${props.risk_level}</span><br>
                        경고 유형: ${props.alert_type || 'N/A'}<br>
                        시간: ${new Date(props.timestamp).toLocaleString()}
                    `);
                });
            }
            catch (error) {
                console.error("위험 국가 지도 데이터를 불러오는 데 실패했습니다:", error);
                showMessageBox('위험 국가 지도 데이터를 불러오는 데 실패했습니다.', 'error');
            }
        }

        // 위협 리포트 목록 가져오기 및 표시
        async function fetchThreatReports() {
            const reportsListDiv = document.getElementById('threat-reports-list');
            const loadingDiv = document.getElementById('reports-loading');
            const errorDiv = document.getElementById('reports-error');

            reportsListDiv.innerHTML = '';
            loadingDiv.classList.remove('hidden');
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/threat_reports`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reports = await response.json();
                
                loadingDiv.classList.add('hidden');

                if (reports.length === 0) {
                    reportsListDiv.innerHTML = '<p class="text-gray-400">업로드된 리포트가 없습니다.</p>';
                } else {
                    reports.forEach(report => {
                        const reportItem = document.createElement('div');
                        reportItem.className = 'flex items-center justify-between bg-gray-700 p-3 rounded-md shadow-sm';
                        reportItem.innerHTML = `
                            <div>
                                <p class="text-base font-medium text-gray-200">${report.title}</p>
                                <p class="text-xs text-gray-400">업로드 날짜: ${new Date(report.upload_date).toLocaleDateString()}</p>
                            </div>
                            <div class="flex space-x-2"> <!-- Flex container for buttons -->
                                <button onclick="downloadThreatReport('${report.id}', '${report.title}')"
                                        class="btn-primary py-1.5 px-3 text-xs"> <!-- Re-using btn-primary -->
                                    다운로드
                                </button>
                                <button onclick="deleteThreatReport('${report.id}')"
                                        class="btn-delete py-1.5 px-3 text-xs"> <!-- New delete button -->
                                    삭제
                                </button>
                            </div>
                        `;
                        reportsListDiv.appendChild(reportItem);
                    });
                }
            }
            catch (error) {
                console.error("위협 리포트 목록을 불러오는 데 실패했습니다:", error);
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
                showMessageBox('위협 리포트 목록을 불러오는 데 실패했습니다.', 'error');
            }
        }

        // 리포트 업로드 처리
        document.getElementById('upload-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const uploadStatusDiv = document.getElementById('upload-status');
            uploadStatusDiv.classList.remove('hidden');
            uploadStatusDiv.className = 'mt-3 text-center text-sm font-medium text-gray-400';
            uploadStatusDiv.textContent = '업로드 중...';

            const form = event.target;
            const formData = new FormData();
            formData.append('title', form.elements['report-title'].value);
            formData.append('file', form.elements['report-file'].files[0]);

            try {
                const response = await fetch(`${API_BASE_URL}/threat_reports/upload`, {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Detail: ${errorData.detail}`);
                }

                const result = await response.json();
                uploadStatusDiv.textContent = `업로드 성공: ${result.message}`;
                uploadStatusDiv.classList.remove('text-gray-400');
                uploadStatusDiv.classList.add('text-green-400');
                form.reset(); // 폼 초기화
                fetchThreatReports(); // 목록 새로고침
                showMessageBox('리포트가 성공적으로 업로드되었습니다!', 'success');
            }
            catch (error) {
                console.error('리포트 업로드 실패:', error);
                uploadStatusDiv.textContent = `업로드 실패: ${error.message || error}`;
                uploadStatusDiv.classList.remove('text-gray-400');
                uploadStatusDiv.classList.add('text-red-400');
                showMessageBox(`리포트 업로드 실패: ${error.message || '알 수 없는 오류'}`, 'error');
            }
        });

        // 리포트 다운로드 처리
        async function downloadThreatReport(reportId, reportTitle) {
            console.log(`Attempting to download report with ID: ${reportId} and Title: ${reportTitle}`);
            try {
                const response = await fetch(`${API_BASE_URL}/threat_reports/download/${reportId}`);
                
                if (!response.ok) {
                    const errorText = await response.text(); // Get raw error text from backend
                    console.error(`Download failed. Server responded with status ${response.status}: ${errorText}`);
                    throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorText}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${reportTitle}.pdf`; // 파일 이름 설정
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showMessageBox('리포트 다운로드를 시작합니다.', 'info');
            }
            catch (error) {
                console.error('리포트 다운로드 실패:', error);
                showMessageBox(`리포트 다운로드에 실패했습니다. 오류: ${error.message}. 서버 로그를 확인해주세요.`, 'error');
            }
        }

        // 리포트 삭제 처리
        async function deleteThreatReport(reportId) {
            if (!confirm('정말로 이 리포트를 삭제하시겠습니까?')) { // Simple confirmation
                return;
            }

            console.log(`Attempting to delete report with ID: ${reportId}`);
            try {
                const response = await fetch(`${API_BASE_URL}/threat_reports/delete/${reportId}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Delete failed. Server responded with status ${response.status}: ${errorText}`);
                    throw new Error(`HTTP error! Status: ${response.status}. Detail: ${errorText}`);
                }

                const result = await response.json();
                showMessageBox(`삭제 성공: ${result.message}`, 'success');
                fetchThreatReports(); // 목록 새로고침
            }
            catch (error) {
                console.error('리포트 삭제 실패:', error);
                showMessageBox(`리포트 삭제에 실패했습니다. 오류: ${error.message || '알 수 없는 오류'}`, 'error');
            }
        }


        // 페이지 로드 시 데이터 로딩
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-gci-year').textContent = '2025'; // 현재 연도를 2025로 설정
            fetchGCIRankings();
            initializeMap(); // 지도 초기화
            fetchRiskyCountriesMapData(); // 지도 데이터 로딩
            fetchThreatReports();
        });
    </script>
</body>
</html>